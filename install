#!/bin/sh

set -e

STOW_PACKAGES_PATH="$HOME"/dotfiles/packages

for i in "$@"; do
    case "$i" in
       -s|--skip-apps)
            skip_apps=1
            shift ;;
        *) ;;
    esac
done

log() {
    echo "[INFO] $1"
}

ensure_dir() {
    mkdir -p "$1"
}

###########################################################
# Install Homebrew
###########################################################
if [ ! -f /opt/homebrew/bin/brew ]; then
    log 'Setup Homebrew'
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

if [ ! -d "$HOME"/dotfiles ]; then
    log 'Clone dotfiles'
    cd "$HOME"
    git clone https://github.com/a1yama/dotfiles.git
fi

if [ -z "$skip_apps" ]; then
    log 'Install Apps and CLIs'
    brew bundle --file "$HOME"/dotfiles/Brewfile
fi

###########################################################
# Stow link
###########################################################
log 'Link dotfiles'
ensure_dir ~/.config
ensure_dir ~/.config/nvim
ensure_dir ~/.config/lazygit
ensure_dir ~/.claude
ensure_dir ~/.codex

stow -vd "$STOW_PACKAGES_PATH" -t "$HOME" $(ls "$STOW_PACKAGES_PATH")

###########################################################
# Install yazi plugins
###########################################################
log 'Install yazi plugins'
if command -v ya >/dev/null 2>&1; then
    XDG_CONFIG_HOME="$HOME"/dotfiles/packages/yazi/.config \
    XDG_DATA_HOME="$HOME"/dotfiles/packages/yazi/.local/share \
    XDG_STATE_HOME="$HOME"/dotfiles/packages/yazi/.local/state \
    XDG_CACHE_HOME="$HOME"/dotfiles/packages/yazi/.cache \
    ya pkg install
else
    log 'yazi is not installed, skipping plugin installation'
fi

###########################################################
# Install tmux plugins (TPM)
###########################################################
log 'Install tmux plugins'
if [ ! -d "$HOME"/.tmux/plugins/tpm ]; then
    git clone https://github.com/tmux-plugins/tpm "$HOME"/.tmux/plugins/tpm
fi
"$HOME"/.tmux/plugins/tpm/bin/install_plugins

###########################################################
# Install Neovim plugins (lazy.nvim)
###########################################################
log 'Install Neovim plugins'
if command -v nvim >/dev/null 2>&1; then
    nvim --headless "+Lazy! sync" +qa
else
    log 'neovim is not installed, skipping plugin installation'
fi

###########################################################
# Setup rbenv and install Ruby
###########################################################
log 'Setup rbenv'
if command -v rbenv >/dev/null 2>&1; then
    eval "$(rbenv init - zsh)"

    # Install latest stable Ruby if not already installed
    if ! rbenv versions | grep -q "3.3"; then
        log 'Installing Ruby 3.3.6 via rbenv'
        rbenv install 3.3.6
        rbenv global 3.3.6
    fi
else
    log 'rbenv is not installed, skipping Ruby setup'
fi

###########################################################
# Install LSP servers (npm/gem)
###########################################################
log 'Install LSP servers'
if command -v npm >/dev/null 2>&1; then
    npm install -g typescript-language-server typescript
else
    log 'npm is not installed, skipping typescript-language-server'
fi

if command -v rbenv >/dev/null 2>&1; then
    eval "$(rbenv init - zsh)"
    gem install ruby-lsp
else
    log 'rbenv is not installed, skipping ruby-lsp'
fi

###########################################################
# create local config files
###########################################################
log 'Create local config files'
touch ~/.zsh/local.zsh
touch ~/.config/git/config.d/local.conf
