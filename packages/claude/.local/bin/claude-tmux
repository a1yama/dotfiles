#!/usr/bin/env bash
set -euo pipefail

AGENT_PREFIX="ğŸ¤–"
LOG_DIR="/tmp/claude-agents"
SKILL_DIR="$HOME/.claude/skills/code-review"

usage() {
  cat <<'EOF'
claude-tmux - tmux Ã— Claude Code ä¸¦åˆ—ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç®¡ç†

Usage:
  claude-tmux spawn "ã‚¿ã‚¹ã‚¯èª¬æ˜"  [--name NAME] [--dir DIR] [--no-review]
  claude-tmux issues 42 43 44
  claude-tmux status
  claude-tmux logs <name>
  claude-tmux kill [name|all]

Subcommands:
  spawn   æ–°ã—ã„tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’èµ·å‹•ï¼ˆå®Ÿè£…å¾Œã«è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
  issues  è¤‡æ•°ã®GitHub Issueã‚’ä¸¦åˆ—ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§å‡¦ç†
  status  å®Ÿè¡Œä¸­ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä¸€è¦§ã¨æœ€æ–°ãƒ­ã‚°ã‚’è¡¨ç¤º
  logs    ç‰¹å®šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ­ã‚°ã‚’ less ã§è¡¨ç¤º
  kill    ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’åœæ­¢

Note:
  spawn/issues ã§èµ·å‹•ã•ã‚Œã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ Edit/Write ãŒæ‰¿èªãªã—ã§è¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚
  ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆãƒ»ç·¨é›†ã‚’ç¢ºèªãªã—ã§å®Ÿè¡Œã—ã¾ã™ã€‚
  æ„å›³ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ãŸã‚ã€å®Ÿè¡Œå¾Œã« git diff ã§å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
EOF
}

require_tmux() {
  if [[ -z "${TMUX:-}" ]]; then
    echo "Error: tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œã—ã¦ãã ã•ã„" >&2
    exit 1
  fi
}

ensure_log_dir() {
  mkdir -p "$LOG_DIR"
}

# spawn: æ–°ã—ã„tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’èµ·å‹•
cmd_spawn() {
  require_tmux
  ensure_log_dir

  local name=""
  local dir=""
  local prompt=""
  local no_review="false"

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --name)
        name="$2"
        shift 2
        ;;
      --dir)
        dir="$2"
        shift 2
        ;;
      --no-review)
        no_review="true"
        shift
        ;;
      *)
        if [[ -z "$prompt" ]]; then
          prompt="$1"
        else
          prompt="$prompt $1"
        fi
        shift
        ;;
    esac
  done

  if [[ -z "$prompt" ]]; then
    echo "Error: ã‚¿ã‚¹ã‚¯èª¬æ˜ã‚’æŒ‡å®šã—ã¦ãã ã•ã„" >&2
    echo "Usage: claude-tmux spawn \"ã‚¿ã‚¹ã‚¯èª¬æ˜\" [--name NAME] [--dir DIR]" >&2
    exit 1
  fi

  if [[ -z "$name" ]]; then
    name="agent-$(date +%s)"
  fi

  local window_name="${AGENT_PREFIX}${name}"
  local log_file="${LOG_DIR}/${name}.log"
  local work_dir="${dir:-$(pwd)}"

  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ï¼ˆã‚¯ã‚©ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å•é¡Œã‚’å›é¿ï¼‰
  local prompt_file="${LOG_DIR}/${name}.prompt"
  printf '%s' "$prompt" > "$prompt_file"

  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œç”¨ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆ
  local runner="${LOG_DIR}/${name}.runner.sh"
  cat > "$runner" <<RUNNER
#!/usr/bin/env bash
name="${name}"
log_file="${log_file}"
prompt_file="${prompt_file}"

echo "=== Claude Agent: \${name} ===" | tee "\${log_file}"
echo "Prompt: \$(cat "\${prompt_file}")" | tee -a "\${log_file}"
echo "Dir: \$(pwd)" | tee -a "\${log_file}"
echo "---" | tee -a "\${log_file}"

# NOTE: Edit/Write ã¯æ‰¿èªãªã—ã§è¨±å¯ã•ã‚Œã¦ã„ã‚‹ï¼ˆ--allowedToolsï¼‰ã€‚
# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆãƒ»ç·¨é›†ã‚’ç¢ºèªãªã—ã§å®Ÿè¡Œã™ã‚‹ã€‚
# Bashç­‰ã®ä»–ãƒ„ãƒ¼ãƒ«ã¯è¨±å¯ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã€‚
claude -p --allowedTools "Edit Write" "\$(cat "\${prompt_file}")" 2>&1 | tee -a "\${log_file}"

echo ""
echo "=== å®Ÿè£…å®Œäº† ===" | tee -a "\${log_file}"

# è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
if [[ "${no_review}" != "true" ]]; then
  changes=\$(git status --short 2>/dev/null || true)
  if [[ -n "\${changes}" ]]; then
    echo "=== ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹ ===" | tee -a "\${log_file}"
    review_file="${LOG_DIR}/\${name}.review-prompt"

    # code-review ã‚¹ã‚­ãƒ«ï¼ˆ~/.claude/skills/code-review/SKILL.mdï¼‰ã‚’ä½¿ç”¨
    if [[ -f "${SKILL_DIR}/SKILL.md" ]]; then
      awk 'BEGIN{f=0} /^---$/{f++; next} f>=2' "${SKILL_DIR}/SKILL.md" > "\${review_file}"
      echo "" >> "\${review_file}"
      echo "è¨€èªå›ºæœ‰ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã¯ ${SKILL_DIR}/languages/ ã«ã‚ã‚Šã¾ã™ã€‚" >> "\${review_file}"
    else
      echo "code-review ã‚¹ã‚­ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åŸºæœ¬ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å®Ÿè¡Œã—ã¾ã™ã€‚" | tee -a "\${log_file}"
      cat > "\${review_file}" <<'REVIEW_EOF'
ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚
å•é¡ŒãŒã‚ã‚‹å ´åˆã®ã¿å ±å‘Šã€‚å•é¡ŒãŒãªã‘ã‚Œã°ã€Œå•é¡Œãªã—ã€ã¨å ±å‘Šã€‚
å„æŒ‡æ‘˜: [é‡è¦åº¦: high/medium/low] ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:è¡Œç•ªå·
å†…å®¹: å•é¡Œã®èª¬æ˜ / ææ¡ˆ: ä¿®æ­£æ¡ˆ
REVIEW_EOF
    fi

    {
      echo ""
      echo "## git status"
      git status --short 2>/dev/null
      echo ""
      echo "## git diff"
      git diff 2>/dev/null
      echo ""
      echo "## git diff --cached"
      git diff --cached 2>/dev/null
      echo ""
      echo "## æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæœªè¿½è·¡ï¼‰"
      git status --short 2>/dev/null | grep '^??' | cut -c4- | while read -r f; do
        echo "--- \$f ---"
        cat "\$f" 2>/dev/null || true
        echo ""
      done
    } >> "\${review_file}"

    cat "\${review_file}" | claude -p --allowedTools "Read" 2>&1 | tee -a "\${log_file}"
    rm -f "\${review_file}"
    echo "=== ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº† ===" | tee -a "\${log_file}"
  else
    echo "å¤‰æ›´ãªã— â€” ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—" | tee -a "\${log_file}"
  fi
fi

echo ""
echo "=== å®Œäº† ==="
say "Claude agent \${name} ãŒå®Œäº†ã—ã¾ã—ãŸ"
rm -f "\${prompt_file}" "\${runner:-}"
read -r -p "Enterã§é–‰ã˜ã‚‹..."
RUNNER
  chmod +x "$runner"

  tmux new-window -n "$window_name" -c "$work_dir" "$runner"

  echo "Agent '${name}' ã‚’èµ·å‹•ã—ã¾ã—ãŸ (window: ${window_name})"
  echo "Log: ${log_file}"
}

# issues: è¤‡æ•°ã®GitHub Issueã‚’ä¸¦åˆ—ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§å‡¦ç†
cmd_issues() {
  require_tmux
  ensure_log_dir

  if [[ $# -eq 0 ]]; then
    echo "Error: Issueç•ªå·ã‚’æŒ‡å®šã—ã¦ãã ã•ã„" >&2
    echo "Usage: claude-tmux issues 42 43 44" >&2
    exit 1
  fi

  for issue_num in "$@"; do
    local prompt="GitHub Issue #${issue_num} ã‚’ \`gh issue view ${issue_num}\` ã§ç¢ºèªã—ã€å†…å®¹ã«åŸºã¥ã„ã¦ã‚¿ã‚¹ã‚¯ã‚’é‚è¡Œã—ã¦ãã ã•ã„ã€‚"
    cmd_spawn "$prompt" --name "issue-${issue_num}"
  done
}

# status: å®Ÿè¡Œä¸­ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä¸€è¦§ã¨æœ€æ–°ãƒ­ã‚°ã‚’è¡¨ç¤º
cmd_status() {
  require_tmux

  local windows
  windows=$(tmux list-windows -F '#{window_name}' 2>/dev/null | grep "^${AGENT_PREFIX}" || true)

  if [[ -z "$windows" ]]; then
    echo "å®Ÿè¡Œä¸­ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“"
    return
  fi

  echo "=== å®Ÿè¡Œä¸­ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ ==="
  echo ""

  while IFS= read -r window_name; do
    local name="${window_name#${AGENT_PREFIX}}"
    local log_file="${LOG_DIR}/${name}.log"

    echo "  ${window_name}"
    if [[ -f "$log_file" ]]; then
      echo "    Log: ${log_file}"
      echo "    æœ€æ–°:"
      tail -3 "$log_file" 2>/dev/null | sed 's/^/      /'
    fi
    echo ""
  done <<< "$windows"
}

# logs: ç‰¹å®šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ­ã‚°ã‚’ less ã§è¡¨ç¤º
cmd_logs() {
  if [[ $# -eq 0 ]]; then
    echo "Error: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã‚’æŒ‡å®šã—ã¦ãã ã•ã„" >&2
    echo "Usage: claude-tmux logs <name>" >&2
    exit 1
  fi

  local name="$1"
  local log_file="${LOG_DIR}/${name}.log"

  if [[ ! -f "$log_file" ]]; then
    echo "Error: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${log_file}" >&2
    exit 1
  fi

  less +F "$log_file"
}

# kill: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’åœæ­¢
cmd_kill() {
  require_tmux

  if [[ $# -eq 0 ]]; then
    echo "Error: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã¾ãŸã¯ 'all' ã‚’æŒ‡å®šã—ã¦ãã ã•ã„" >&2
    echo "Usage: claude-tmux kill [name|all]" >&2
    exit 1
  fi

  local target="$1"

  if [[ "$target" == "all" ]]; then
    local windows
    windows=$(tmux list-windows -F '#{window_name}' 2>/dev/null | grep "^${AGENT_PREFIX}" || true)

    if [[ -z "$windows" ]]; then
      echo "å®Ÿè¡Œä¸­ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“"
      return
    fi

    while IFS= read -r window_name; do
      tmux kill-window -t ":${window_name}" 2>/dev/null || true
      echo "åœæ­¢: ${window_name}"
    done <<< "$windows"
  else
    local window_name="${AGENT_PREFIX}${target}"
    if tmux kill-window -t ":${window_name}" 2>/dev/null; then
      echo "åœæ­¢: ${window_name}"
    else
      echo "Error: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ '${target}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >&2
      exit 1
    fi
  fi
}

# ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
case "${1:-}" in
  spawn)
    shift
    cmd_spawn "$@"
    ;;
  issues)
    shift
    cmd_issues "$@"
    ;;
  status)
    cmd_status
    ;;
  logs)
    shift
    cmd_logs "$@"
    ;;
  kill)
    shift
    cmd_kill "$@"
    ;;
  -h|--help|"")
    usage
    ;;
  *)
    echo "Error: ä¸æ˜ãªã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ '$1'" >&2
    usage
    exit 1
    ;;
esac
