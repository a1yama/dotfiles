# tmux: beginner-friendly configuration with discoverable key bindings.

##### Prefix customization #################################################
# Keep leader actions ergonomic by moving the prefix from the default C-b to C-q.
unbind C-b
set -g prefix C-q
bind C-q send-prefix

##### Pane management ######################################################
# Intuitive split bindings using Vim-style s/v for horizontal/vertical splits.
# s: split horizontally (new pane below)
# v: split vertically (new pane to the right)
bind s split-window -v  # horizontal split (split below)
bind v split-window -h  # vertical split (split right)
# Remove legacy split bindings to prevent accidental use.
unbind '"'
unbind %

# Vim-style pane navigation for seamless movement with h/j/k/l.
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Resizing panes with uppercase H/J/K/L; -r allows holding the key down.
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

##### Quality-of-life tweaks ###############################################
# Enable mouse interaction for selecting panes, resizing, and scrolling.
set -g mouse on

# Advertise 256-color support so applications can use richer color themes.
set -g default-terminal "tmux-256color"

# Keep a longer scrollback history for commands that produce lots of output.
set -g history-limit 10000

# Use vi-style keys inside copy mode for consistency with common workflows.
set -g mode-keys vi

# Copy mode settings: exit copy mode after yanking
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-selection-and-cancel


# Rename window with Prefix + r.
bind r command-prompt -I "#W" "rename-window '%%'"

# Rename pane with Prefix + R.
bind R command-prompt -I "#T" "select-pane -T '%%'"

# Start counting windows and panes at 1 so numbering matches mental models.
set -g base-index 1
setw -g pane-base-index 1

##### Visual improvements ##################################################
# Keep the status bar at the bottom (tmux default, stated explicitly for clarity).
set -g status-position bottom

set-option -g @c-base-100 "#001C23"
set-option -g @c-base-content "#FFD6A7"
set-option -g @c-primary "#BEFF00"
set-option -g @c-primary-content "#507000"
set-option -g @c-neutral "#000000"
set-option -g @c-neutral-content "#FFFFFF"
set-option -g @c-info "#00BAFE"
set-option -g @c-info-content "#042E49"

set-option -g pane-border-style "fg=#{@c-base-content}"
set-option -g pane-active-border-style "fg=#{@c-primary}"
set-option -gw window-status-bell-style "bold"
setw -g monitor-bell off
set -g visual-bell off
set -g bell-action any

# --- status-left ---
set -g status-left-length 60
set-option -g status-left '#{?client_prefix,#[fg=#fab387 bg=#{@c-base-100}]#[bg=#fab387 fg=#1e1e2e bold] PREFIX #[fg=#fab387 bg=#{@c-base-100}] ,}#{?pane_in_mode,#[fg=#cba6f7 bg=#{@c-base-100}]#[bg=#cba6f7 fg=#1e1e2e bold] COPY #[fg=#cba6f7 bg=#{@c-base-100}] ,}#( \
  bg="#{@c-base-100}"; \
  color="#{@c-info}"; \
  text_fg="#{@c-info-content}"; \
  label=" #S "; \
  echo "#[bg=$bg,fg=$color]#[bg=$color,fg=$text_fg]$label#[bg=$bg,fg=$color]  "; \
)'
# --- status-right ---
set -g status-right-length 100
set -g status-right '#[fg=#585b70 bg=#1e1e2e]#[bg=#585b70 fg=#cdd6f4] ↓#{download_speed} ↑#{upload_speed} #[fg=#585b70 bg=#1e1e2e] #[fg=#74c7ec bg=#1e1e2e]#[bg=#74c7ec fg=#1e1e2e] #{cpu_percentage} │ #{ram_percentage} #[fg=#74c7ec bg=#1e1e2e] #[fg=#89b4fa bg=#1e1e2e]#[bg=#89b4fa fg=#1e1e2e bold]  %m/%d %H:%M #[fg=#89b4fa bg=#1e1e2e]'

# --- window tabs ---
set-option -gw window-status-format '#( \
  label=" #I:#W "; \
  bg="#{@c-base-100}"; \
  color="#{@c-neutral}"; \
  text_fg="#{@c-neutral-content}"; \
  if [ "#{window_bell_flag}" = "1" ]; then \
    label=" 󱅫 #I:#W "; \
    color="#{@c-info}"; \
    text_fg="#{@c-info-content}"; \
  fi; \
  echo "#[bg=$bg,fg=$color]#[bg=$color,fg=$text_fg]$label#[bg=$bg,fg=$color]"; \
)'
set-option -gw window-status-current-format '#( \
  bg="#{@c-base-100}"; \
  color="#{@c-primary}"; \
  text_fg="#{@c-primary-content}"; \
  label=" #I:#W "; \
  echo "#[bg=$bg,fg=$color]#[bg=$color,fg=$text_fg,bold]$label#[bg=$bg,fg=$color]"; \
)'
setw -g window-status-separator      ''

# Pane borders (subtle, same as background)
set -g pane-border-style "fg=#313244"
set -g pane-active-border-style "fg=#313244"
set -g pane-border-status top
set -g pane-border-format "#{?pane_active,#[fg=#89b4fa]#T,#[fg=#6c7086]#T}"

# Dim inactive panes slightly
set -g window-style "bg=#1a1a26"
set -g window-active-style "bg=#1e1e2e"

# Make copy-mode highlight more visible.
setw -g mode-style "bg=#45475a fg=#cdd6f4"

# Message style
set -g message-style "bg=#89b4fa fg=#1e1e2e"
set -g message-command-style "bg=#fab387 fg=#1e1e2e"

##### Sensible defaults ####################################################
# Lower escape time speeds up prefix combos without hurting latency.
set -s escape-time 0

# Update status bar frequently so bell indicators appear promptly.
set -g status-interval 2

# Keep windows named after running commands for easier identification.
set -g automatic-rename on
set -g renumber-windows on

# Prevent shells from renaming panes/windows automatically
set -g allow-rename off

##### Plugins ##################################################################
# Plugin manager (TPM)
set -g @plugin 'tmux-plugins/tpm'

# tmux-fzf: fuzzy finder for sessions, windows, panes, and more
set -g @plugin 'sainnhe/tmux-fzf'
TMUX_FZF_LAUNCH_KEY="f"

# CPU and memory monitoring
set -g @plugin 'tmux-plugins/tmux-cpu'

# Network speed monitoring
set -g @plugin 'tmux-plugins/tmux-net-speed'

# Quick fzf shortcuts (single step)
bind / display-popup -E "tmux list-sessions -F '#{session_name}' | fzf --reverse | xargs tmux switch-client -t"
bind w display-popup -E "tmux list-windows -a -F '#{session_name}:#{window_index} #{window_name}' | fzf --reverse | cut -d' ' -f1 | xargs tmux switch-client -t"
bind e command-prompt -p "new session:" "new-session -s '%%'"

# Show keybindings with fzf (Japanese help)
bind ? display-popup -E -w 50 -h 26 "echo '\
s         下に分割\n\
v         右に分割\n\
h/j/k/l   ペイン移動\n\
H/J/K/L   ペインリサイズ\n\
R         ペイン名変更\n\
x         ペインを閉じる\n\
z         ペイン最大化\n\
c         新規ウィンドウ\n\
n/p       次/前のウィンドウ\n\
w         ウィンドウ一覧\n\
r         ウィンドウ名変更\n\
&         ウィンドウ削除\n\
/         セッション切替\n\
e         新規セッション\n\
\$         セッション名変更\n\
d         デタッチ\n\
:         コマンドモード\n\
?         このヘルプ\n\
' | fzf --reverse --header='C-q + key'"

# Initialize TPM (keep this line at the very bottom)
run '~/.tmux/plugins/tpm/tpm'
